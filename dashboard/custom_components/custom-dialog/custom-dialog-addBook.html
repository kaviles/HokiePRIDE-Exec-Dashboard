<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">

<dom-module id="custom-dialog-addBook">

    <template>
        <style>    
            :host {
                background-color: white;
                padding: 5px;
                margin: 5px;

                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--layout-center-justified);

                border-style: solid;
                border-width: 1px;
                border-color: blue;
            }
            #header {
                margin: 0px 0px 0px 0px;
            }
            #mainPage {
                margin: 5px 5px 5px 5px;
                padding: 0px 0px 0px 0px;

                /*min-width: 400px;*/
                /*min-height: 350px;*/
            }
            .mainForm {
                max-width: 600px;

                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                @apply(--layout-center);
                @apply(--layout-center-justified);
            }
            .formInput {
                margin: 5px 5px 5px 5px;
                padding: 0px 0px 0px 0px;
            }
            #buttons {

                margin: 5px 5px 5px 5px;
                padding: 0px 0px 0px 0px;

                @apply(--layout-vertical);
                @apply(--layout-center);
                @apply(--layout-center-justified);
            }
            #autofillBtns {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
                @apply(--layout-center);
                @apply(--layout-center-justified);
            }
            paper-button {
                margin: 5px 5px 5px 5px;
            }
        </style>

        <div id='header'>Add Book to Library</div>

        <iron-pages id='mainPage' selected='0'>
            <template is='dom-repeat' items='{{pages}}' as='page'>
                <div class='mainForm' id='mainForm{{page.num}}'>
                    <template is='dom-repeat' items='{{inputs}}' as='input'>
                        <paper-input class='formInput' id='{{input.id}}' label='{{input.label}}' type='{{input.type}}'
                        minlength='{{input.minlength}}' maxlength='{{input.maxlength}}' required='{{input.required}}' 
                        preventInvalidInput auto-validate pattern='{{input.pattern}}' error-message='{{input.error}}'>
                        </paper-input>
                    </template>
                </div>
            </template>
        </iron-pages>

        <div id='buttons'>
            <div id='autofillButns'>
                <paper-icon-button id='autoFillLeft' icon='chevron-left' on-tap='autoFillLeft' hidden></paper-icon-button>

                <paper-button id='autoFillButt' raised role='button' on-tap='validateISBN13'>Auto Fill Form</paper-button>
                <paper-tooltip id='tooltip_autoFillButt' for='autoFillButt' position='bottom'><span id='tooltiptext_autoFillButt'></span></paper-tooltip>

                <paper-icon-button id='autoFillRight' icon='chevron-right' on-tap='autoFillRight' hidden></paper-icon-button>
            </div>

            <paper-button id='genLibIDButt' raised role='button' on-tap='ajaxGenLibIDRequest'>Generate LibID</paper-button>

            <paper-button id='addBookButt' raised role='button' on-tap='validateForm'>Add Book to Library</paper-button>
            <paper-tooltip id='tooltip_addBookButt' for='addBookButt' position='bottom'><span id='tooltiptext_addBookButt'></span></paper-tooltip>
        </div>

        <iron-ajax id='ajaxAutoFill' url='../../phpcommands/retrieveBookData.php' content-type='application/json' handle-as='json' method='POST' on-response='ajaxAutoFillResponse'>
        </iron-ajax>
        <iron-ajax id='ajaxGenLibID' url='../../phpcommands/generateLibID.php' handle-as='json' method='GET' on-response='ajaxGenLibIDResponse'></iron-ajax>
        <iron-ajax id='ajaxAdd' url='../../phpcommands/addBook.php' handle-as='json' method='GET' on-response='ajaxAddResponse'></iron-ajax>
    </template>

    <script>
    Polymer( {
        is: 'custom-dialog-addBook', 
        properties: {},
        /**
         * Specifies the label of the individual tile.
         *
         * @attribute label
         * @type string
         * @default ''
         */

        ready: function() {
            this.inputs = [
            {id:'title', label:'Title', minlength:'', maxlength:'', type:'text', required:'false', error:'', pattern:'.*'},
            {id:'author', label:'Author(s)', minlength:'', maxlength:'', type:'text', required:'false', error:'fname1 lname1, fname2 lname2...', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
            {id:'pub', label:'Publisher', minlength:'', maxlength:'', type:'text', required:'false', error:'', pattern:'.*'},
            {id:'year', label:'Year', minlength:'4', maxlength:'4', type:'text', required:'false', error:'4 digits', pattern:'[0-9]{4}'},
            {id:'isbn13', label:'ISBN13', minlength:'13', maxlength:'16', type:'text', required:'true', error:'13 digits', pattern:'[0-9]{13}'},
            {id:'loc', label:'Library of Congress #', minlength:'', maxlength:'', type:'text', required:'false', error:'', pattern:'.*'},
            {id:'dcc', label:'Dewey Decimal #', minlength:'', maxlength:'', type:'text', required:'false', error:'', pattern:'.*'},
            {id:'tags', label:'Tags (comma sep)', minlength:'', maxlength:'', type:'text', required:'false', error:'tag1, tag2, tag3...', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
            {id:'covurl', label:'Cover URL', minlength:'', maxlength:'', type:'url', required:'false', error:'www.example.com', pattern:'.*'},
            {id:'desc', label:'Description', minlength:'', maxlength:'', type:'text', required:'false', error:'', pattern:'.*'},
            {id:'libid', label:'Library ID', minlength:'13', maxlength:'13', type:'text', required:'true', error:'Input 13 character library ID', pattern:'^[a-zA-Z0-9]*$'}
            ];

            // TODO: Find a way to add these pages dynamically
            this.pages = [{num:'0'}];
        },

        validateForm: function() {
            var selectedForm = this.$.mainPage.querySelector('.mainForm.iron-selected');

            var formInputArr = selectedForm.getElementsByClassName('formInput');
            var formInputCount = formInputArr.length;

            var validCount = 0;
            for (var i = 0; i < formInputCount; i++) {

                if (formInputArr[i].required == 'true' && formInputArr[i].value.length == 0) {
                    formInputArr[i].invalid = true;
                }

                if (!formInputArr[i].invalid) {
                    // console.log('validCount incremented.');
                    validCount++;
                }
                else {
                    // console.log('validCount not incremented.');
                }
            }

            if (validCount == formInputCount) {
                req = '{"title":"' + formInputArr[0].value + 
                    '","author":"' + formInputArr[1].value + 
                    '","pub":"' + formInputArr[2].value + 
                    '","year":"' + formInputArr[3].value + 
                    '","isbn13":"' + formInputArr[4].value + 
                    '","loc":"' + formInputArr[5].value + 
                    '","dcc":"' + formInputArr[6].value + 
                    '","tags":"' + formInputArr[7].value + 
                    '","covurl":"' + formInputArr[8].value + 
                    '","desc":"' + formInputArr[9].value + 
                    '","libid":"' + formInputArr[10].value + '"}';
                this.ajaxAddRequest(req);
            }
        },

        validateISBN13: function() {
            var selectedForm = this.$.mainPage.querySelector('.mainForm.iron-selected');

            var isbn13Inp = selectedForm.querySelector('#isbn13');
 
            // Clear the form, reset isbn13
            var isbn13 = isbn13Inp.value;

            if (isbn13 && isbn13.length == 13) {
                this.clearForm();
                this.ajaxAutoFillRequest('{"isbn13":"' + isbn13 + '"}');
            }
            else {
                isbn13Inp.invalid = true;
            }
        },

        resetPages: function() {
            for (var i = 0; i < this.pages.length - 1; i++) {
                this.pop('pages');
            }
        },

        autoFillForm: function(jsonObject) {
            // console.log(jsonObject);

            this.resetPages();

            var mainPage = this.$.mainPage;
            var resultsCount = jsonObject.bookData.length;
            var pageCount = this.pages.length;

            if (resultsCount > pageCount) {
                resultsCount = pageCount;
            }

            var button1 = this.$.autoFillRight;
            var button2 = this.$.autoFillLeft;

            if (resultsCount > 1) {
                button1.removeAttribute('hidden');
                button2.removeAttribute('hidden');
            }
            else {
                button1.setAttribute('hidden', '');
                button2.setAttribute('hidden', '');
            }

            for (var i = 0; i < resultsCount; i++) {
                var bookData = jsonObject.bookData[i];
                // console.log(bookData);

                this.push('pages', {num:resultsCount.toString()});

                var form = mainPage.querySelector('#mainForm' + i);
                form.querySelector('#title').value = bookData.title;
                form.querySelector('#author').value = bookData.author;
                form.querySelector('#pub').value = bookData.publisher;
                form.querySelector('#year').value = bookData.year;
                form.querySelector('#isbn13').value = bookData.isbn13;
                form.querySelector('#loc').value = bookData.loc;
                form.querySelector('#dcc').value = bookData.dcc;
                form.querySelector('#tags').value = bookData.tag;
                form.querySelector('#covurl').value = bookData.covurl;
                form.querySelector('#desc').value = bookData.desc;
                form.querySelector('#libid').value = bookData.libid;

                form.querySelector('#isbn13').disabled = true;
                form.querySelector('#libid').disabled = true;
            }

            mainPage.select('0');
        },

        autoFillRight: function() {
            this.$.mainPage.selectNext();
        },

        autoFillLeft: function() {
            this.$.mainPage.selectPrevious();
        },

        clearForm: function() {
            var mainPage = this.$.mainPage;

            var button1 = this.$.autoFillRight;
            var button2 = this.$.autoFillLeft;
            button1.setAttribute('hidden', '');
            button2.setAttribute('hidden', '');

            for (var i = 0; i < this.pages.length; i++) {
                var selectedForm = mainPage.querySelector('#mainForm' + i);
                var formInputArr = selectedForm.getElementsByClassName('formInput');
                var formInputCount = formInputArr.length;

                for (var j = 0; j < formInputCount; j++) {
                    formInputArr[j].value = '';
                    formInputArr[j].invalid = false;
                }
            }
        },

        disableForm: function(val) {
            var selectedForm = this.$.mainPage.querySelector('.mainForm.iron-selected');

            var formInputArr = selectedForm.getElementsByClassName('formInput');
            var formInputCount = formInputArr.length;

            var button1 = this.$.autoFillButt;
            var button2 = this.$.addBookButt;
            var button3 = this.$.autoFillRight;
            var button4 = this.$.autoFillLeft;
            var button5 = this.$.genLibIDButt;

            button1.disabled = val;
            button2.disabled = val;
            button5.disabled = val;

            for (var i = 0; i < formInputCount; i++) {
                formInputArr[i].disabled = val;
            }

            if (!val && this.pages.length > 1) {
                button3.removeAttribute('hidden');
                button4.removeAttribute('hidden');
            }
            else {
                button3.setAttribute('hidden', '');
                button4.setAttribute('hidden', '');
            }
        },

        clearAutoFillButt: function() {
            var ttip = this.$.tooltip_autoFillButt;
            ttip.hide();
            ttip.querySelector('#tooltiptext_autoFillButt').innerHTML = '';

            this.$.autoFillButt.style.backgroundColor = "white";
        },

        clearGenLibIDButt: function() {
            this.$.genLibIDButt.style.backgroundColor = "white";
        },

        clearAddButt: function() {
            var ttip = this.$.tooltip_addBookButt;
            ttip.hide();
            ttip.querySelector('#tooltiptext_addBookButt').innerHTML = '';

            this.$.addBookButt.style.backgroundColor = "white";
        },

        ajaxAutoFillRequest: function(request) {
            this.clearAddButt();
            this.clearAutoFillButt();
            this.disableForm(true);

            var aj = this.$.ajaxAutoFill;
            aj.params = request;
            aj.generateRequest();
        },

        ajaxAutoFillResponse: function(e) {
            // console.log(e.detail.response);
            this.disableForm(false);
            var resp = JSON.parse(e.detail.response);
            var ttip = this.$.tooltip_autoFillButt;
            var ttiptext = ttip.querySelector('#tooltiptext_autoFillButt');
            var button = this.$.autoFillButt;

            if (resp.responseCode == 1) {
                button.style.backgroundColor = "green";
                this.autoFillForm(resp);
            }
            else {
                button.style.backgroundColor = "red";
            }

            this.clearAddButt();
            this.clearGenLibIDButt();

            ttiptext.innerHTML = resp.message;
            ttip.show();
        },

        ajaxGenLibIDRequest: function() {
            this.clearAddButt();
            this.clearAutoFillButt();
            this.disableForm(true);

            var aj = this.$.ajaxGenLibID;
            // aj.params = request;
            aj.generateRequest();
        },

        ajaxGenLibIDResponse: function(e) {
            // console.log('Message: ' + e.detail.response);
            this.disableForm(false);
            var resp = JSON.parse(e.detail.response);

            var selectedForm = this.$.mainPage.querySelector('.mainForm.iron-selected');
            var libidInp = selectedForm.querySelector('#libid');
            var isbn13Inp = selectedForm.querySelector('#isbn13');

            var button = this.$.genLibIDButt;

            if (resp.responseCode == 1) {
                button.style.backgroundColor = "green";

                libidInp.value = resp.libid;
                libidInp.disabled = true;
                isbn13Inp.disabled = true;
            }
            else {
                button.style.backgroundColor = "red";
            }

            this.clearAddButt();
        },

        ajaxAddRequest: function(request) {
            this.clearAddButt();
            this.clearAutoFillButt();
            this.disableForm(true);

            var aj = this.$.ajaxAdd;
            aj.params = request;
            aj.generateRequest();
        },

        ajaxAddResponse: function(e) {
            // console.log('Message: ' + e.detail.response);
            this.disableForm(false);
            var resp = JSON.parse(e.detail.response);
            var ttip = this.$.tooltip_addBookButt;
            var ttiptext = ttip.querySelector('#tooltiptext_addBookButt');
            var button = this.$.addBookButt;

            if (resp.responseCode == 1) {
                button.style.backgroundColor = "green";
                this.clearForm();
                this.clearGenLibIDButt();
                this.clearAutoFillButt();
            }
            else {
                button.style.backgroundColor = "red";
            }

            ttiptext.innerHTML = resp.message;
            ttip.show();
        },
    });
  </script>

</dom-module>
