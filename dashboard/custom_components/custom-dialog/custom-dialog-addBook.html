<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="custom-dialog-addBook" layout vertical center center-justified>

	<template>
		<style>    
			:host {
				background-color: white;
				padding: 5px;
				margin: 5px;

				/*border-style: solid;
				border-width: 1px;
				border-color: orange;*/
			}
			#header {
				margin: 0px 0px 0px 0px;
			}
			#mainForm {
				max-width: 400px;
			}
			#mainInput {
				margin: 5px 5px 5px 5px;
				padding: 0px 0px 0px 0px;
			}
			paper-button {
				margin: 10px 0px 0px 0px;
			}
		</style>

		<div id='header'>Add Book to Library</div>
		<section id='mainForm' layout horizontal wrap>
	    	<template repeat='{{input in inputs}}'>
	    		<paper-input-decorator id='mainInput' label='{{input.label}}' floatinglabel error='{{input.error}}'>
					<input is="core-input" id='{{input.id}}' placeholder="{{input.label}}" pattern='{{input.pattern}}' type='{{input.type}}'>
	    		</paper-input-decorator>
	    	</template>
    	</section>
    	<core-tooltip id='tooltipAutoFillButt' label='' position='bottom'>
	    	<paper-button id='autoFillButt' raised role='button' on-tap='{{validateISBN}}'>Auto Fill Form</paper-button>
		</core-tooltip>
    	<core-tooltip id='tooltipAddBookButt' label='' position='bottom'>
	    	<paper-button id='addBookButt' raised role='button' on-tap='{{validateForm}}'>Add Book to Library</paper-button>
		</core-tooltip>

		<core-ajax id='ajaxAutoFill' url='' params='' handleAs='json' method='GET' on-core-response='{{ajaxAutoFillResponse}}'></core-ajax>
	    <core-ajax id='ajaxAdd' url='../../phpcommands/addBook.php' params='' handleAs='json' method='POST' on-core-response='{{ajaxAddResponse}}'></core-ajax>
	</template>

	<script>
    Polymer( 'custom-dialog-addBook', {
    /**
     * Specifies the label of the individual tile.
     *
     * @attribute label
     * @type string
     * @default ''
     */

    ready: function() {
    	this.inputs = [
    	{id:'tit', label:'Title', error:'', type:'text', pattern:'.*'},
    	{id:'auth', label:'Author(s)', error:'fname1 lname1, fname2 lname2...', type:'text', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
    	{id:'gen', label:'Genre (comma sep)', type:'text', error:'genre1, genre2, genre3...', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
    	{id:'year', label:'Year', error:'4 digits', type:'text', pattern:'[0-9]{4}'},
    	{id:'pub', label:'Publisher', error:'', type:'text', pattern:'.*'},
    	{id:'isbn', label:'ISBN', error:'13 digits', type:'text', pattern:'[0-9]{13}'},
    	{id:'loc', label:'Library of Congress #', error:'', type:'text', pattern:'.*'},
    	{id:'dcc', label:'Dewey Decimal #', error:'', type:'text', pattern:'.*'},
    	{id:'tags', label:'Tags (comma sep)', error:'tag1, tag2, tag3...', type:'text', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
    	{id:'comms', label:'Comments', error:'', type:'text', pattern:'.*'}];
	},

	validateForm: function() {
		var papDec = this.$.mainForm.getElementsByTagName('paper-input-decorator');
		var papDecCount = papDec.length;

		papDec[5].firstElementChild.setAttribute('required', ''); // set isbn required

		var validCount = 0;
		var valueArray = new Array(papDecCount);
		for (var i = 0; i < papDecCount; i++) {
			var inp = papDec[i].firstElementChild;
			valueArray[i] = inp.value;
			papDec[i].isInvalid = !inp.validity.valid;

			if (!papDec[i].isInvalid) {
				validCount++;
			}
		}

		if (validCount == papDecCount) {
			req = '{"title":"' + valueArray[0] + '","author":"' + valueArray[1] + '","genre":"' + valueArray[2] + '","year":"' + valueArray[3] + '","publisher":"' + valueArray[4] + '","isbn":"' + valueArray[5] + '","loc":"' + valueArray[6] + '","dcc":"' + valueArray[7] + '","tags":"' + valueArray[8] + '","comms":"' + valueArray[9] + '"}';
			this.ajaxAddRequest(req);
		}
	},

	validateISBN: function() {
		var papDec = this.$.mainForm.getElementsByTagName('paper-input-decorator');
		var inp = papDec[5].firstElementChild;
		inp.setAttribute('required', '');
		papDec[5].isInvalid = !inp.validity.valid;

		if (!papDec[5].isInvalid) {
			var isbn = inp.value;
			this.ajaxAutoFillRequest(isbn);
		}
	},

	autoFillForm: function(resp) {
		// console.log(resp);
		// Is it possible for there to be more than one item?
		this.clearForm();
		var items = resp.items;

		var volinfo0 = items[0].volumeInfo; // The volume info of the first item.
		
		var responseArray = new Array(10);

		responseArray[0] = (volinfo0.subtitle) ? volinfo0.title + ': ' + volinfo0.subtitle : volinfo0.title;
		responseArray[1] = volinfo0.authors;
		responseArray[2] = volinfo0.categories;
		responseArray[3] = volinfo0.publishedDate.substring(0, 4);
		responseArray[4] = volinfo0.publisher;
		responseArray[5] = volinfo0.industryIdentifiers;
		responseArray[6] = '';
		responseArray[7] = '';
		responseArray[8] = '';
		responseArray[9] = volinfo0.description;

		var papDec = this.$.mainForm.getElementsByTagName('paper-input-decorator');

		papDec[0].firstElementChild.value = responseArray[0];
		var i = 0; 
		while (i < responseArray[1].length) {
			papDec[1].firstElementChild.value += responseArray[1][i];
			i++;

			if (i < responseArray[1].length) {
				papDec[1].firstElementChild.value += ', ';
			}
		}

		i = 0; 
		while (i < responseArray[2].length) {
			papDec[2].firstElementChild.value += responseArray[2][i];
			i++;
			
			if (i < responseArray[2].length) {
				papDec[2].firstElementChild.value += ', ';
			}
		}
		papDec[3].firstElementChild.value = responseArray[3];
		papDec[4].firstElementChild.value = responseArray[4];
		papDec[5].firstElementChild.value = (responseArray[5][0].type == 'ISBN_13') ? responseArray[5][0].identifier : responseArray[5][1].identifier;
		papDec[6].firstElementChild.value = responseArray[6];
		papDec[7].firstElementChild.value = responseArray[7];
		papDec[8].firstElementChild.value = responseArray[8];
		papDec[9].firstElementChild.value = responseArray[9];
	},

	clearForm: function() {
		var papDec = this.$.mainForm.getElementsByTagName('paper-input-decorator');
		var papDecCount = papDec.length;
		for (var i = 0; i < papDecCount; i++) {
			papDec[i].firstElementChild.value = '';
		}
	},

	ajaxAutoFillRequest: function(isbn) {
		var aj = this.$.ajaxAutoFill;
		aj.url = 'https://www.googleapis.com/books/v1/volumes?q=isbn:' + isbn;
		aj.go();
		console.log('request');
	},

	ajaxAutoFillResponse: function(e) {
		var resp = e.detail.response;
		var tip = this.$.tooltipAutoFillButt;
		var button = tip.querySelector('paper-button#autoFillButt');

		if (resp.totalItems > 0) {
			button.style.backgroundColor = "green";
			tip.label = 'Result found.'
			this.autoFillForm(resp);
		}
		else {
			button.style.backgroundColor = "red";
			tip.label = 'No results.';
		}

	},

	ajaxAddRequest: function(request) {
		var aj = this.$.ajaxAdd;
		aj.params = request;
		// // Find a way to use auto attribute without it making requests on startup calling the go method.
		aj.go();
	},

	ajaxAddResponse: function(e) {
		var resp = JSON.parse(e.detail.response);
		// console.log('Message: ' + resp.message);
		var tip = this.$.tooltipAddBookButt;
		var button = tip.querySelector('paper-button#addBookButt');

		if (resp.responseCode == 1) {
			button.style.backgroundColor = "green";
			this.clearForm();
		}
		else {
			button.style.backgroundColor = "red";
		}

		tip.label = resp.message;
		tip.show = true;
	},

    });
  </script>

</polymer-element>
