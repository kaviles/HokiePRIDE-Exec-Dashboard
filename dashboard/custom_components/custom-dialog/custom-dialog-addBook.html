<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input-decorator.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../../../bower_components/core-ajax/core-ajax.html">

<polymer-element name="custom-dialog-addBook" layout vertical center center-justified>

	<template>
		<style>    
			:host {
				background-color: white;
				padding: 5px;
				margin: 5px;

				/*border-style: solid;
				border-width: 1px;
				border-color: orange;*/
			}
			#header {
				margin: 0px 0px 0px 0px;
			}
			#mainForm {
				max-width: 400px;
			}
			#mainInput {
				margin: 5px 5px 5px 5px;
				padding: 0px 0px 0px 0px;
			}
			paper-button {
				margin: 10px 0px 0px 0px;
			}
		</style>

		<div id='header'>Add Book to Library</div>
		<section id='mainForm' layout horizontal wrap center center-justified>
	    	<template repeat='{{input in inputs}}'>
	    		<paper-input-decorator id='mainInput' label='{{input.label}}' floatinglabel error='{{input.error}}'>
					<input is="core-input" id='{{input.id}}' placeholder="{{input.label}}" pattern='{{input.pattern}}' type='{{input.type}}'>
	    		</paper-input-decorator>
	    	</template>
    	</section>
    	<core-tooltip id='tooltipAutoFillButt' label='' position='bottom'>
	    	<paper-button id='autoFillButt' raised role='button' on-tap='{{validateISBN13}}'>Auto Fill Form</paper-button>
		</core-tooltip>
    	<core-tooltip id='tooltipAddBookButt' label='' position='bottom'>
	    	<paper-button id='addBookButt' raised role='button' on-tap='{{validateForm}}'>Add Book to Library</paper-button>
		</core-tooltip>

		<core-ajax id='ajaxAutoFill' url='' params='' handleAs='json' method='GET' on-core-response='{{ajaxAutoFillResponse}}'></core-ajax>
	    <core-ajax id='ajaxAdd' url='../../phpcommands/addBook.php' params='' handleAs='json' method='POST' on-core-response='{{ajaxAddResponse}}'></core-ajax>
	</template>

	<script>
    Polymer( 'custom-dialog-addBook', {
    /**
     * Specifies the label of the individual tile.
     *
     * @attribute label
     * @type string
     * @default ''
     */

    ready: function() {
    	this.inputs = [
    	{id:'title', label:'Title', type:'text', error:'', pattern:'.*'},
    	{id:'author', label:'Author(s)', type:'text', error:'fname1 lname1, fname2 lname2...', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
    	{id:'pub', label:'Publisher', type:'text', error:'', pattern:'.*'},
    	{id:'year', label:'Year', type:'text', error:'4 digits', pattern:'[0-9]{4}'},
    	{id:'isbn13', label:'ISBN13', type:'text', error:'13 digits', pattern:'[0-9]{13}'},
    	{id:'loc', label:'Library of Congress #', type:'text', error:'', pattern:'.*'},
    	{id:'dcc', label:'Dewey Decimal #', type:'text', error:'', pattern:'.*'},
    	{id:'tags', label:'Tags (comma sep)', type:'text', error:'tag1, tag2, tag3...', pattern:'([a-zA-Z0-9.]+,? )*[a-zA-Z0-9.]+'},
    	{id:'covurl', label:'Cover URL', type:'url', error:'www.example.com', pattern:'.*'},
    	{id:'desc', label:'Description', type:'text', error:'', pattern:'.*'},
    	{id:'libid', label:'Library ID', type:'text', error:'Numeric only', pattern:'[0-9]*'}];
	},

	validateForm: function() {
		var mForm = this.$.mainForm;
		mForm.querySelector('#isbn13').setAttribute('required', ''); // set isbn13 required
		// mForm.querySelector('#libid').setAttribute('required', ''); // set libid required
		var papDecArr = mForm.querySelectorAll('#mainInput');
		var papDecCount = papDecArr.length;

		var validCount = 0;
		for (var i = 0; i < papDecCount; i++) {
			// This should be the input within the paper-decorator
			var inp = papDecArr[i].firstElementChild;
			papDecArr[i].isInvalid = !inp.validity.valid; // Validate the input

			if (!papDecArr[i].isInvalid) {
				validCount++;
			}
		}

		if (validCount == papDecCount) {
			req = '{"title":"' + mForm.querySelector('#title').value + 
				'","author":"' + mForm.querySelector('#author').value + 
				'","pub":"' + mForm.querySelector('#pub').value + 
				'","year":"' + mForm.querySelector('#year').value + 
				'","isbn13":"' + mForm.querySelector('#isbn13').value + 
				'","loc":"' + mForm.querySelector('#loc').value + 
				'","dcc":"' + mForm.querySelector('#dcc').value + 
				'","tags":"' + mForm.querySelector('#tags').value + 
				'","covurl":"' + mForm.querySelector('#covurl').value + 
				'","desc":"' + mForm.querySelector('#desc').value + 
				'","libid":"' + mForm.querySelector('#libid').value + '"}';
			this.ajaxAddRequest(req);
		}
	},

	validateISBN13: function() {
		var isbn13Inp= this.$.mainForm.querySelector('#isbn13');
		isbn13Inp.setAttribute('required', '');
		isbn13Inp.parentElement.isInvalid = !isbn13Inp.validity.valid;

		if (!isbn13Inp.parentElement.isInvalid) {
			var isbn13 = isbn13Inp.value;
			this.ajaxAutoFillRequest(isbn13);
		}
	},

	autoFillForm: function(googObj) {
		console.log(googObj);

		var items = googObj.items;
		var volinfo0 = items[0].volumeInfo; // The volume info of the first item.
		var respObj = new Object;

		respObj.tit = (volinfo0.subtitle) ? volinfo0.title + ': ' + volinfo0.subtitle : volinfo0.title;
		respObj.author = (volinfo0.authors) ? volinfo0.authors : ''; // This will be an array of authors
		respObj.pub = (volinfo0.publisher) ? volinfo0.publisher : '';
		respObj.year = (volinfo0.publishedDate.substring(0, 4)) ? volinfo0.publishedDate.substring(0, 4) : '';
		// respObj.isbn13 = (volinfo0.industryIdentifiers[0].type == 'ISBN_13') ? volinfo0.industryIdentifiers[0].identifier : volinfo0.industryIdentifiers[1].identifier;
		respObj.isbn13 = this.$.mainForm.querySelector("#isbn13").value;
		respObj.loc = '';
		respObj.dcc = '';
		respObj.tag = (volinfo0.categories) ? volinfo0.categories : ''; // This will be an array
		respObj.covurl = (volinfo0.imageLinks.thumbnail) ? volinfo0.imageLinks.thumbnail : '';
		respObj.desc = (volinfo0.description) ? volinfo0.description : '';
		// respObj.libid = volinfo0.; // Is this needed here?

		// var papDec = this.$.mainForm.querySelectorAll('#mainInput');

		this.clearForm();
		this.clearAddButt();

		var mForm = this.$.mainForm;

		var i = 0;
		mForm.querySelector('#title').value = respObj.tit;

		var authorInp = mForm.querySelector('#author');
		while (i < respObj.author.length) {
			authorInp.value += respObj.author[i];
			i++;

			if (i < respObj.author.length) {
				authorInp.value += ', ';
			}
		}

		mForm.querySelector('#pub').value = respObj.pub;
		mForm.querySelector('#year').value = respObj.year;
		mForm.querySelector('#isbn13').value = respObj.isbn13;
		mForm.querySelector('#loc').value = respObj.loc;
		mForm.querySelector('#dcc').value = respObj.dcc;

		i = 0;
		var tagsInp = mForm.querySelector('#tags');
		while (i < respObj.tag.length) {
			tagsInp.value += respObj.tag[i];
			i++;
			
			if (i < respObj.tag.length) {
				tagsInp.value += ', ';
			}
		}

		mForm.querySelector('#covurl').value = respObj.covurl;
		mForm.querySelector('#desc').value = respObj.desc;

	},

	clearForm: function() {
		var papDec = this.$.mainForm.querySelectorAll('#mainInput');;
		var papDecCount = papDec.length;
		for (var i = 0; i < papDecCount; i++) {
			papDec[i].firstElementChild.value = '';
		}
	},

	clearAutoFillButt: function() {
		var tip1 = this.$.tooltipAutoFillButt;
		tip1.label = '';
		tip1.querySelector('paper-button#autoFillButt').style.backgroundColor = "white";

	},

	clearAddButt: function() {
		var tip2 = this.$.tooltipAddBookButt;
		tip2.label = '';
		tip2.querySelector('paper-button#addBookButt').style.backgroundColor = "white";
	},

	ajaxAutoFillRequest: function(isbn13) {
		var aj = this.$.ajaxAutoFill;
		aj.url = 'https://www.googleapis.com/books/v1/volumes?q=isbn:' + isbn13;
		aj.go();
	},

	ajaxAutoFillResponse: function(e) {
		var googObj = e.detail.response;
		var tip = this.$.tooltipAutoFillButt;
		var button = tip.querySelector('paper-button#autoFillButt');
		var itemCount = googObj.totalItems;

		if (itemCount > 0) {
			button.style.backgroundColor = "green";
			tip.label = itemCount + ' result(s) found.'
			this.autoFillForm(googObj);
		}
		else {
			button.style.backgroundColor = "red";
			tip.label = 'No results.';
			this.clearForm();
		}
	},

	ajaxAddRequest: function(request) {
		var aj = this.$.ajaxAdd;
		aj.params = request;
		// // Find a way to use auto attribute without it making requests on startup calling the go method.
		aj.go();
	},

	ajaxAddResponse: function(e) {
		// console.log('Message: ' + e.detail.response);
		var resp = JSON.parse(e.detail.response);
		var tip = this.$.tooltipAddBookButt;
		var button = tip.querySelector('paper-button#addBookButt');

		if (resp.responseCode == 1) {
			button.style.backgroundColor = "green";
			this.clearForm();
			this.clearAutoFillButt();
		}
		else {
			button.style.backgroundColor = "red";
			this.clearAutoFillButt();
		}

		tip.label = resp.message;
		tip.show = true;
	},

    });
  </script>

</polymer-element>
